<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>divisasCU — Mercado informal (Realtime)</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --brand:#0a2a6a; --gradient-start:#1a2f6b; --gradient-end:#2c5282; --accent:#ff6b35;
      --up:#059669; --down:#dc2626; --neutral:#6b7280; --bg:#f8fafc; --card:#fff; --muted:#64748b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:#111}
    header{background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;gap:12px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo .name{font-size:1.2rem}
    .controls{display:flex;align-items:center;gap:10px}
    .btn{background:#ffffff12;border:1px solid rgba(255,255,255,.15);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .btn.primary{background:linear-gradient(135deg,#22c55e,#16a34a);border:none}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.2)}
    .clock{background:rgba(255,255,255,.08);padding:8px 10px;border-radius:8px;font-weight:800;display:flex;gap:8px;align-items:center}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px}
    .accent-line{height:6px;background:linear-gradient(90deg,var(--gradient-start),var(--accent),var(--gradient-end));border-radius:6px;margin-bottom:14px}
    .card{background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.08);overflow:hidden;margin-bottom:16px}
    .card-head{background:linear-gradient(135deg,var(--gradient-start),var(--gradient-end));color:#fff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;font-weight:800}
    .tabs{display:flex;gap:8px;padding:12px 0}
    .tab{padding:10px 12px;border-radius:10px;background:#f1f5f9;font-weight:700;cursor:pointer}
    .tab.active{background:linear-gradient(90deg,#eff6ff,#e0f2fe);color:var(--brand)}
    .table-wrap{overflow:auto;padding:12px}
    table{width:100%;border-collapse:collapse}
    thead th{background:#f8fafc;padding:12px;text-align:left;color:var(--muted);font-weight:800;border-bottom:2px solid #eef2f7}
    tbody td{padding:14px;border-bottom:1px solid #f1f5f9;vertical-align:middle}
    .currency{display:flex;align-items:center;gap:12px;font-weight:800}
    .flag{width:36px;height:24px;object-fit:cover;border-radius:4px;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .rate{font-size:1.25rem;font-weight:900;color:var(--brand)}
    .trend{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800}
    .trend.up{color:#fff;background:var(--up)}
    .trend.down{color:#fff;background:var(--down)}
    .trend.neutral{color:#fff;background:var(--neutral)}
    .editor input[type="number"]{width:110px;padding:8px;border-radius:8px;border:1px solid #e6eef7;font-weight:800;text-align:center}
    .editor select{padding:8px;border-radius:8px;border:1px solid #e6eef7}
    .small{font-size:.9rem;color:var(--muted)}
    footer{padding:18px;text-align:center;color:var(--muted);font-weight:700}
    .right{display:flex;gap:8px;align-items:center}
    @media(max-width:760px){ .rate{font-size:1rem} .flag{width:28px;height:18px} }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <svg width="36" height="36" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="#fff"/><path d="M32 14a1.5 1.5 0 0 1 1.5 1.5v3.2c4.9.5 8.3 3.2 8.3 7 0 3.8-3 5.8-8.3 7v6c2.7-.3 4.7-1.3 6.4-2.7a1.5 1.5 0 1 1 2 2.2c-2.4 2-5.3 3.2-8.4 3.6v3.2a1.5 1.5 0 1 1-3 0v-3.2c-5-.5-8.6-3.1-8.6-7.1 0-4.2 3.4-6.1 8.6-7.3v-5.8c-2.3.2-4 .9-5.7 2.1a1.5 1.5 0 0 1-2-2.2c2.4-1.8 5.2-2.8 7.7-3v-3.2A1.5 1.5 0 0 1 32 14Z" fill="#0a2a6a"/></svg>
    <div>
      <div class="name">divisasCU</div>
      <div class="small">Mercado informal - tiempo real</div>
    </div>
  </div>

  <div class="controls right">
    <div id="userBox" class="small">No autenticado</div>
    <button id="btnSign" class="btn">Iniciar sesión</button>
    <button id="btnSignOut" class="btn ghost" style="display:none">Cerrar sesión</button>
    <div class="clock" id="clock">00:00</div>
  </div>
</header>

<div class="wrap">
  <div class="accent-line"></div>

  <div style="display:flex;justify-content:space-between;gap:12px;align-items:center;margin-bottom:12px">
    <div class="tabs">
      <div id="tabTableBtn" class="tab active">Tabla</div>
      <div id="tabChartBtn" class="tab">Gráficos</div>
      <div id="tabCalcBtn" class="tab">Calculadora</div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <button id="btnEdit" class="btn">Editar</button>
      <button id="btnApply" class="btn primary" style="display:none">Aplicar</button>
      <div class="small">Sesión de administrador: <strong id="adminFlag">NO</strong></div>
    </div>
  </div>

  <!-- Tabla -->
  <div id="tabTable" class="card">
    <div class="card-head">
      <div><i class="fa-solid fa-exchange-alt"></i> DIVISAS - MERCADO INFORMAL</div>
      <div class="small">Datos sincronizados con Firestore</div>
    </div>
    <div class="table-wrap">
      <table id="ratesTable">
        <thead>
          <tr>
            <th>Moneda</th>
            <th>Tasa (CUP)</th>
            <th>Delta (24h)</th>
            <th>Tendencia</th>
          </tr>
        </thead>
        <tbody><!-- rows creadas por JS --></tbody>
      </table>
    </div>
  </div>

  <!-- Charts -->
  <div id="tabChart" class="card" style="display:none">
    <div class="card-head"><div><i class="fa-solid fa-chart-line"></i> Gráficos</div><div class="small">(Basado en tasas actuales)</div></div>
    <div style="padding:12px">
      <canvas id="lineChart" height="200"></canvas>
    </div>
  </div>

  <!-- Calculadora -->
  <div id="tabCalc" class="card" style="display:none">
    <div class="card-head"><div><i class="fa-solid fa-calculator"></i> Calculadora</div><div class="small">CUP ↔ Moneda</div></div>
    <div style="padding:12px;display:grid;grid-template-columns:1fr 140px 160px;gap:8px;align-items:center">
      <input id="calcAmount" type="number" placeholder="Cantidad" />
      <select id="calcCurrency"></select>
      <button id="calcBtn" class="btn">Convertir</button>
      <div id="calcResult" style="grid-column:1/4;padding:12px;font-weight:900"></div>
    </div>
  </div>

  <footer>© <strong>Darekho</strong> — Última actualización: <span id="lastDate">--/--/----</span></footer>
</div>

<!-- Firebase SDKs (compat for simple usage) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
/* ============================
  CONFIGURA AQUI: pega tu firebaseConfig
  y tu ADMIN_EMAIL (correo Google que será admin).
  - firebaseConfig lo copias desde Project settings > Your apps (web)
  - ADMIN_EMAIL: el email con el que iniciarás sesión para poder editar
   ============================ */
const ADMIN_EMAIL = "TU_ADMIN_EMAIL@ejemplo.com"; // <-- reemplaza por tu correo admin
const firebaseConfig = {
  /* --- PON AQUI TU FIREBASE_CONFIG --- */
  apiKey: "REEMPLAZA_APIKEY",
  authDomain: "REEMPLAZA_AUTH_DOMAIN",
  projectId: "REEMPLAZA_PROJECT_ID",
  // resto de fields...
};

/* Inicializar Firebase */
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* Nombre del documento donde guardaremos tasas (un único documento) */
const RATES_DOC = "rates/latest"; // collection "rates", doc "latest"

/* Monedas iniciales si no hay datos en Firestore */
const defaultRows = [
  { code:"EUR", label:"EUR", flag:"https://flagcdn.com/eu.svg", rate:460.00, delta:+0.00, trend:"neutral" },
  { code:"USD", label:"USD", flag:"https://flagcdn.com/us.svg", rate:410.00, delta:+0.00, trend:"neutral" },
  { code:"MLC", label:"MLC", flag:"https://eltoque.com/images/mlc.png", rate:195.00, delta:+0.00, trend:"neutral" },
  { code:"CAD", label:"CAD", flag:"https://flagcdn.com/ca.svg", rate:280.00, delta:+0.00, trend:"neutral" },
  { code:"CHF", label:"CHF", flag:"https://flagcdn.com/ch.svg", rate:408.13, delta:+1.51, trend:"up" },
  { code:"MXN", label:"MXN", flag:"https://flagcdn.com/mx.svg", rate:21.22, delta:+0.19, trend:"up" },
  { code:"BRL", label:"BRL", flag:"https://flagcdn.com/br.svg", rate:69.57, delta:+0.77, trend:"up" },
  { code:"ZELLE", label:"ZELLE", flag:"https://via.placeholder.com/64/7c2eff/fff?text=Z", rate:411.44, delta:+0.19, trend:"up" },
  { code:"CLA", label:"CLA", flag:"https://via.placeholder.com/64/eee/333?text=CLA", rate:402.69, delta:+0.33, trend:"up" }
];

let rows = [];          // datos en memoria
let isAdmin = false;    // si el usuario actual es el admin autorizado
let editMode = false;   // si se está editando

/* Utilidades */
const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
const fmt = (n) => Number(n).toLocaleString("es-ES", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

/* Reloj y fecha */
function tickClock(){
  const now = new Date();
  $("#clock").textContent = now.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
  $("#lastDate").textContent = now.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric'}) + " • " + now.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'});
}
setInterval(tickClock, 1000); tickClock();

/* Render tabla */
function renderTable(){
  const tbody = $("#ratesTable tbody");
  tbody.innerHTML = "";
  rows.forEach((r, idx) => {
    const tr = document.createElement("tr");

    const tdMon = document.createElement("td");
    tdMon.innerHTML = `<div class="currency"><img class="flag" src="${r.flag}" alt="${r.code}"> <div>${r.label}</div></div>`;
    tr.appendChild(tdMon);

    const tdRate = document.createElement("td");
    tdRate.className = "rate";
    if(editMode && isAdmin){
      tdRate.innerHTML = `<div class="editor"><input type="number" step="0.01" data-idx="${idx}" data-field="rate" value="${r.rate}"></div>`;
    } else {
      tdRate.textContent = `${fmt(r.rate)} CUP`;
    }
    tr.appendChild(tdRate);

    const tdDelta = document.createElement("td");
    if(editMode && isAdmin){
      tdDelta.innerHTML = `<div class="editor"><input type="number" step="0.01" data-idx="${idx}" data-field="delta" value="${r.delta}"></div>`;
    } else {
      const sign = r.delta >= 0 ? "+" : "";
      tdDelta.textContent = `${sign}${fmt(r.delta)}`;
    }
    tr.appendChild(tdDelta);

    const tdTrend = document.createElement("td");
    const trendClass = r.trend === "up" ? "trend up" : (r.trend === "down" ? "trend down" : "trend neutral");
    const icon = r.trend === "up" ? "fa-arrow-up" : (r.trend === "down" ? "fa-arrow-down" : "fa-equals");
    if(editMode && isAdmin){
      // select to change trend
      const sel = document.createElement("select");
      sel.className = "trend-select";
      sel.setAttribute("data-idx", idx);
      sel.innerHTML = `
        <option value="neutral" ${r.trend==="neutral"?"selected":""}>Estable</option>
        <option value="up" ${r.trend==="up"?"selected":""}>Subiendo</option>
        <option value="down" ${r.trend==="down"?"selected":""}>Bajando</option>
      `;
      tdTrend.appendChild(sel);
    } else {
      tdTrend.innerHTML = `<div class="${trendClass}"><i class="fa-solid ${icon}"></i> ${r.trend === "up" ? "Subiendo" : (r.trend === "down" ? "Bajando" : "Estable")}</div>`;
    }
    tr.appendChild(tdTrend);

    tbody.appendChild(tr);
  });

  // attach listeners to new inputs (only in editMode)
  if(editMode && isAdmin){
    $$("#ratesTable input[data-field]").forEach(inp=>{
      inp.addEventListener("input", (e)=>{
        const idx = Number(e.target.dataset.idx);
        const field = e.target.dataset.field;
        rows[idx][field] = Number(e.target.value);
      });
    });
    $$("#ratesTable select.trend-select").forEach(sel=>{
      sel.addEventListener("change", (e)=>{
        const idx = Number(e.target.dataset.idx);
        rows[idx].trend = e.target.value;
      });
    });
  }
}

/* Inicializar UI de calculadora y chart */
function refreshCalcOptions(){
  const sel = $("#calcCurrency");
  sel.innerHTML = "";
  rows.forEach(r=>{
    const opt = document.createElement("option");
    opt.value = r.code;
    opt.textContent = `${r.code} — ${fmt(r.rate)} CUP`;
    sel.appendChild(opt);
  });
}

let lineChart;
function updateChart(){
  const ctx = document.getElementById("lineChart").getContext("2d");
  const labels = Array.from({length:7}, (_,i)=>{
    const d = new Date(); d.setDate(d.getDate()-(6-i));
    return d.toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'});
  });
  const datasets = rows.slice(0,3).map((r,i)=>{
    // small synthetic data around rate
    const data = labels.map((_,j)=> Number((r.rate * (1 + (Math.sin((j+1)*1.2+i)/100))).toFixed(2)));
    return { label: r.code, data, tension:0.3 };
  });

  if(lineChart) lineChart.destroy();
  lineChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
  });
}

/* -------------------------
   Firestore real-time sync
   ------------------------- */
async function ensureDocExistence(){
  const ref = db.doc(RATES_DOC);
  const snap = await ref.get();
  if(!snap.exists){
    // crear doc con datos por defecto
    await ref.set({ rows: defaultRows, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
  }
}

/* Listener: cuando cambian datos en Firestore (todos los visitantes recibirán esto) */
function startRealtimeListener(){
  const ref = db.doc(RATES_DOC);
  ref.onSnapshot(doc => {
    if(!doc.exists) return;
    const data = doc.data();
    rows = data.rows || defaultRows;
    renderTable();
    refreshCalcOptions();
    updateChart();
  }, err => {
    console.error("Listener error:", err);
  });
}

/* Guardar cambios: aplica lo editado en Firestore (solo admin podrá hacerlo por reglas) */
async function applyChanges(){
  if(!isAdmin) return alert("Debes iniciar sesión con la cuenta admin para aplicar cambios.");
  try{
    await db.doc(RATES_DOC).set({ rows, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    alert("Cambios aplicados y sincronizados.");
    editMode = false;
    $("#btnApply").style.display = "none";
    $("#btnEdit").textContent = "Editar";
  }catch(e){
    console.error(e);
    alert("Error al aplicar cambios: " + e.message);
  }
}

/* -------------------------
   Authentication (Google)
   ------------------------- */
$("#btnSign").addEventListener("click", async ()=>{
  const provider = new firebase.auth.GoogleAuthProvider();
  try{
    await auth.signInWithPopup(provider);
  }catch(e){ console.error(e); alert("Error login: " + e.message); }
});

$("#btnSignOut").addEventListener("click", async ()=>{
  await auth.signOut();
});

/* Observador de estado de auth */
auth.onAuthStateChanged(user=>{
  if(user){
    $("#userBox").textContent = user.email;
    $("#btnSign").style.display = "none";
    $("#btnSignOut").style.display = "inline-block";
    // es admin si email coincide con ADMIN_EMAIL
    isAdmin = (user.email === ADMIN_EMAIL);
    $("#adminFlag").textContent = isAdmin ? "SI" : "NO";
    // btnEdit visible solo si admin
    $("#btnEdit").style.display = isAdmin ? "inline-block" : "none";
  } else {
    $("#userBox").textContent = "No autenticado";
    $("#btnSign").style.display = "inline-block";
    $("#btnSignOut").style.display = "none";
    isAdmin = false;
    $("#adminFlag").textContent = "NO";
    $("#btnEdit").style.display = "none";
  }
});

/* -------------------------
   UI events
   ------------------------- */
$("#btnEdit").addEventListener("click", ()=>{
  if(!isAdmin) return alert("Solo el administrador puede editar (inicia sesión con la cuenta admin).");
  editMode = !editMode;
  $("#btnApply").style.display = editMode ? "inline-block" : "none";
  $("#btnEdit").textContent = editMode ? "Cancelar" : "Editar";
  renderTable();
});

$("#btnApply").addEventListener("click", applyChanges);

/* Tabs */
$("#tabTableBtn").addEventListener("click", ()=>{ $("#tabTable").style.display="block"; $("#tabChart").style.display="none"; $("#tabCalc").style.display="none"; $("#tabTableBtn").classList.add("active"); $("#tabChartBtn").classList.remove("active"); $("#tabCalcBtn").classList.remove("active"); });
$("#tabChartBtn").addEventListener("click", ()=>{ $("#tabTable").style.display="none"; $("#tabChart").style.display="block"; $("#tabCalc").style.display="none"; $("#tabTableBtn").classList.remove("active"); $("#tabChartBtn").classList.add("active"); $("#tabCalcBtn").classList.remove("active"); updateChart(); });
$("#tabCalcBtn").addEventListener("click", ()=>{ $("#tabTable").style.display="none"; $("#tabChart").style.display="none"; $("#tabCalc").style.display="block"; $("#tabTableBtn").classList.remove("active"); $("#tabChartBtn").classList.remove("active"); $("#tabCalcBtn").classList.add("active"); refreshCalc(); });

/* Calculadora */
function refreshCalc(){
  refreshCalcOptions();
  $("#calcResult").textContent = "";
}
$("#calcBtn").addEventListener("click", ()=>{
  const amt = Number($("#calcAmount").value || 0);
  const code = $("#calcCurrency").value;
  const r = rows.find(x=>x.code === code);
  if(!r || !amt) return $("#calcResult").textContent = "Introduce cantidad y moneda válida";
  $("#calcResult").textContent = `${fmt(amt / r.rate)} ${r.code} (con tasa ${fmt(r.rate)} CUP)`;
});

/* -------------------------
   Inicialización
   ------------------------- */
(async function init(){
  try{
    await ensureDocExistence();
    startRealtimeListener();
  }catch(e){
    console.error("Init error:", e);
    // Si Firestore no responde, cargamos local por ahora
    rows = defaultRows;
    renderTable();
    refreshCalcOptions();
    updateChart();
  }
})();
</script>
</body>
</html>
